<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f9fafa;
      font-family: 'Segoe UI', sans-serif;
    }

    .app-wrapper {
      max-width: 800px;
      margin: 40px auto;
    }

    .section-header {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .card {
      border-radius: 10px;
      border: none;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .form-check-input:checked {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }

    .sub-section {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .badge-label {
      font-size: 0.85rem;
      padding: 0.4em 0.6em;
    }

    .list-group-sm .list-group-item {
      font-size: 0.95rem;
      padding: 0.4rem 0.75rem;
    }
  </style>
</head>

<body>
  <div class="text-center mb-4">
    <img
      src="https://images.contentstack.io/v3/assets/blt827157d7af7bc6d4/blt539b6710c5d23513/63306748763d011cd3e925bd/megaworld-logo.png"
      alt="Header Image"
      class="img-fluid"
      style="max-width: 100%; width: 600px"
    />
  </div>

  <div id="app" class="app-wrapper">
    <div class="text-center">
      <h1>MCD Memo Routing</h1>
    </div>

    <div class="card p-4 mt-4">
      <div class="section-header mb-3">
        <i class="bi bi-person-lines-fill"></i> Requestor Information
      </div>

      <div class="mb-3">
        <label for="name" class="form-label">Uploader Name</label>
        <input type="text" class="form-control" id="name" v-model="formData.name" placeholder="Enter your full name">
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Uploader Email Address</label>
        <input type="email" class="form-control" id="email" v-model="formData.email" placeholder="name@example.com">
      </div>

      <div class="mb-3">
        <label for="memoType" class="form-label">Memo Preparer</label>
        <input type="text" class="form-control" id="memoType" v-model="formData.memoType" placeholder="Enter preparer name">
      </div>

      <div class="mb-3">
        <label for="email" class="form-label">Memo Preparer Email Address</label>
        <input type="email" class="form-control" id="email1" v-model="formData.email1" placeholder="name@example.com">
      </div>

      <div class="mb-3">
        <label for="dateType" class="form-label">Date Indicated in the Memo:</label>
        <input type="date" class="form-control" id="memoType" v-model="formData.dateType">
      </div>


      <div class="mb-3">
        <label for="additionalMemoInfo" class="form-label">Subject of the Memo</label>
        <textarea class="form-control" id="additionalMemoInfo" v-model="formData.additionalMemoInfo" placeholder="Enter Subject of the Memo..."></textarea>
        Can't find the subject of the memo? <a
          href="https://drive.google.com/file/d/1ZRqxk2BtbkoLc_yQr-fnuDA2t5MNnCvh/view?usp=sharing" target="_blank"
          class="mt-2 d-inline-block"> Click here</a>
      </div>

      <!-- New Checkbox Grid -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Select Property/Coverage</label>
        <div class="row">
          <div class="col-md-4 mb-2" v-for="option in extraOptions" :key="option.value">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" :id="option.value" :value="option.value" v-model="selectedExtras">
              <label class="form-check-label" :for="option.value">{{ option.label }}</label>
            </div>
          </div>
        </div>
        <!-- Optional "Other" Text Field -->
        <div class="mt-3">
          <label for="otherExtra" class="form-label">Other (if not listed above)</label>
          <input
      type="text"
      id="otherExtra"
      class="form-control"
      v-model="otherExtraOption"
      placeholder="Specify other department or team..."
    />
        </div>
      </div>

    </div>

    <hr>


    <!-- Main Departments -->
    <div class="card p-4 mb-4">
      <div class="section-header">
        <i class="bi bi-diagram-3"></i> Memo Routing Path
      </div>
      <p class="text-muted mb-3">Select department head/s that need to approve this memo:</p>
      <div v-for="item in mainCheckboxes" :key="item.value" class="form-check mb-2">
        <input class="form-check-input" type="checkbox" :id="item.value" :value="item.value" v-model="selectedMain">
        <label class="form-check-label fw-semibold" :for="item.value">{{ item.label }}</label>
      </div>
    </div>

    <!-- Sub-Approvers -->
    <div v-if="selectedMain.includes('MGL')" class="card p-4 mb-4 sub-section">
      <div class="section-header">
        <span class="badge bg-primary badge-label">MOSD Sub-Approvers</span>
      </div>
      <div v-for="sub in subCheckboxes" :key="sub.value" class="form-check ms-2 mb-2">
        <input class="form-check-input" type="checkbox" :id="sub.value" :value="sub.value" v-model="selectedSub">
        <label class="form-check-label" :for="sub.value">{{ sub.label }}</label>
      </div>
    </div>

    <div v-if="selectedMain.includes('KMV')" class="card p-4 mb-4 sub-section">
      <div class="section-header">
        <span class="badge bg-success badge-label">BCM Sub-Approvers</span>
      </div>
      <div v-for="sub in subCheckboxes1" :key="sub.value" class="form-check ms-2 mb-2">
        <input class="form-check-input" type="checkbox" :id="sub.value" :value="sub.value" v-model="selectedSub">
        <label class="form-check-label" :for="sub.value">{{ sub.label }}</label>
      </div>
    </div>

    <div v-if="selectedMain.includes('LDA')" class="card p-4 mb-4 sub-section">
      <div class="section-header">
        <span class="badge bg-danger badge-label">LEASING Sub-Approvers</span>
      </div>
      <div v-for="sub in subCheckboxes2" :key="sub.value" class="form-check ms-2 mb-2">
        <input class="form-check-input" type="checkbox" :id="sub.value" :value="sub.value" v-model="selectedSub">
        <label class="form-check-label" :for="sub.value">{{ sub.label }}</label>
      </div>
    </div>

    <!-- Approval Summary -->
    <div class="card p-4 mt-4">
      <div class="section-header">
        <i class="bi bi-check2-circle"></i> Approval Summary
      </div>

      <div v-if="approvalSummary.length">
        <div v-for="(item, index) in approvalSummary" :key="index" class="mb-3">
          <h6 class="mb-1"><i class="bi bi-building"></i> {{ item.department }}</h6>
          <ul class="list-group list-group-sm">
            <li v-for="person in item.approvers" :key="person" class="list-group-item py-1 px-3">
              <i class="bi bi-person-check text-primary me-2"></i> {{ person }}
            </li>
          </ul>
        </div>
      </div>
      <div v-else class="text-muted">
        No department head/s or sub-approver/s selected.
      </div>
    </div>

    <!-- User Info -->

    <!-- File Upload & Submit -->
    <div class="card p-4 mt-4">
      <div class="section-header mb-3">
        <i class="bi bi-upload"></i> Upload Memo Document
      </div>

      <!-- Resubmission Checkbox -->
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="resubmissionCheck" v-model="isResubmission">
        <label class="form-check-label" for="resubmissionCheck">
      Resubmission for approval?
    </label>
      </div>

      <!-- Primary File Upload -->
      <div class="mb-3">
        <label for="extraFile" class="form-label">Attach Memo document</label>
        <input type="file" class="form-control" accept="application/pdf" @change="handleFileUpload">
        <small class="text-muted">Only PDF files up to 32MB are allowed.</small>
      </div>

      <!-- Extra Upload Field if Resubmission is checked -->
      <div class="mb-3" v-if="isResubmission">
        <label for="extraFile" class="form-label">Attach Disapproval Page Document</label>
        <input type="file" class="form-control" id="extraFile" accept="application/pdf" @change="handleRevisedFileUpload">
        <small class="text-muted">Only PDF files up to 32MB are allowed.</small>
      </div>

      <div v-if="fileError" class="alert alert-danger py-2">
        {{ fileError }}
      </div>

      <div v-if="loading" class="d-flex align-items-center text-primary mb-3">
        <div class="spinner-border me-2" role="status" aria-hidden="true"></div>
        <strong>Submitting memo, please wait...</strong>
      </div>

      <button class="btn btn-primary" :disabled="loading" @click="submitForm">
    <span v-if="!loading"><i class="bi bi-send"></i> Submit Approval Request</span>
    <span v-else><i class="bi bi-clock-history"></i> Submitting...</span>
  </button>
    </div>

    <div v-if="generatedRefNumber" class="alert alert-success mt-3">
      <strong>Reference Number:</strong> {{ generatedRefNumber }}
    </div>

  </div>

  <script>
    // Clear cookies
  function clearCookies() {
    document.cookie.split(";").forEach(function(cookie) {
      const eqPos = cookie.indexOf("=");
      const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
      document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
    });
    console.log("Cookies cleared.");
  }

  // Track user activity
  let inactivityTimer;
  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
      clearCookies();
      console.log("User inactive for 5 mins. Cookies cleared.");
    }, 5 * 60 * 1000); // 5 minutes
  }

  // Reset timer on any interaction
  ['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt =>
    document.addEventListener(evt, resetInactivityTimer)
  );
  resetInactivityTimer(); // Start timer on page load

  // Clear cookies on page unload
  window.addEventListener("beforeunload", () => {
    clearCookies();
  });
    new Vue({
      el: '#app',
      data: {
        mainCheckboxes: [
          { label: 'Graham Coates', value: 'GMC' },
          { label: 'Rosalyn Segura', value: 'RCS' },
          { label: 'Michael Lao', value: 'MGL' },
          { label: 'Tinay Villanueva', value: 'KMV' },
          { label: 'Lorence Aurelio', value: 'LDA' }
        ],
        subCheckboxes: [
          { label: 'Jaye Pizarro', value: 'JAYE' },
          { label: 'Joy Melitante', value: 'JOY' },
          { label: 'Alex Flores', value: 'ALEX' },
          { label: 'Aurora Pastolero', value: 'AU' },
          { label: 'Mariano Caleja', value: 'MAR' }
        ],
        subCheckboxes1: [
          { label: 'Ernesto "Bimbo" Andrade', value: 'EBA' },
          { label: 'Dustin Sta. Maria', value: 'DSM' },
          { label: 'Jenel Ann Cruzgarcia', value: 'JAC' },
          { label: 'Doreen Penilla', value: 'DP' }
        ],
        subCheckboxes2: [
          { label: 'Frances Armian', value: 'FA' },
          { label: 'Denisse Malong', value: 'DM' },
          { label: 'Kevin Lin', value: 'KL' },
          { label: 'Juvi Masilungan', value: 'JM' },
          { label: 'Jhoanalyn Gatdula', value: 'JG' },
          { label: 'Mary Arceo', value: 'MA' }
        ],
        extraOptions: [
          {label:'Alabang West',value:'AW'},
{label:'Arcovia City',value:'AC'},
{label:'Broadway Centrum',value:'BC'},
{label:'Boracay Newcoast',value:'BN'},
{label:'California Garden Square',value:'CGS'},
{label:'The Clubhouse Temple Drive',value:'CTD'},
{label:'Clark Cityfront',value:'CCF'},
{label:'Capital Town',value:'CT'},
{label:'Eastwood City',value:'EWC'},
{label:'Forbes Town',value:'FT'},
{label:'Iloilo Business Park',value:'IBP'},
{label:'Lucky Chinatown',value:'LCT'},
{label:'McKinley Hill',value:'MKH'},
{label:'Maple Grove',value:'MG'},
{label:'Newport City',value:'NP'},
{label:'Paseo Center',value:'PC'},
{label:'San Antonio Place',value:'SAP'},
{label:'Three Central Makati',value:'TCM'},
{label:'San Lorenzo Place',value:'SLP'},
{label:'Southwoods',value:'SW'},
{label:'Twin Lakes',value:'TL'},
{label:'The Mactan Newtown',value:'TMN'},
{label:'The Upper East House',value:'TUE'},
{label:'Uptown Bonifacio',value:'UB'},
{label:'Village Square',value:'VS'},
{label:'Westside City',value:'WSC'},
        ],
        generatedRefNumber: '',
        otherExtraOption: '', 
        selectedMain: [],
        selectedSub: [],
        selectedExtras: [],
        formData: {
          name: '',
          email: '',
          email1: '',
          memoType: '',
          dateType:'',
          additionalMemoInfo: ''
        },
        uploadedFile: null,
        isResubmission: false,
        revisedFile: null,
        fileError: '',
        loading: false
      },
      computed: {
        approvalSummary() {
          const map = {
            MGL: this.subCheckboxes,
            KMV: this.subCheckboxes1,
            LDA: this.subCheckboxes2
          };
          const summary = [];
          this.selectedMain.forEach(dept => {
            const approvers = (map[dept] || [])
              .filter(p => this.selectedSub.includes(p.value))
              .map(p => p.label);
            summary.push({
              department: dept,
              approvers: approvers.length ? approvers : ['No approvers selected']
            });
          });
          return summary;
        },
          isFormValid() {
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const hasExtras = this.selectedExtras.length > 0 || this.otherExtraOption.trim() !== '';
          
          const isFileValid = this.isResubmission 
            ? this.revisedFile !== null  // Check for revised file if resubmission is true
            : this.uploadedFile !== null;  // Otherwise check for the main uploaded file

          return (
            this.selectedMain.length > 0 &&
            hasExtras &&
            isFileValid &&  // Validate based on the type of file required
            this.formData.name.trim() !== '' &&
            emailPattern.test(this.formData.email) &&
            emailPattern.test(this.formData.email1) &&
            this.formData.memoType !== '' &&
            this.formData.dateType !== '' &&
            this.formData.additionalMemoInfo.trim() !== ''
          );
        }

      },
      methods: {
         handleRevisedFileUpload(event) {
        const file = event.target.files[0];
        this.fileError = ''; // Reset any previous errors

        if (file) {
          if (file.type !== "application/pdf") {
            this.fileError = "Only PDF files are allowed.";
            this.revisedFile = null;
            return;
          }

          if (file.size > 32 * 1024 * 1024) {
            this.fileError = "File exceeds the 32MB size limit.";
            this.revisedFile = null;
            return;
          }

          this.revisedFile = file;
        }
      },
      handleFileUpload(event) {
        const file = event.target.files[0];
        this.fileError = '';
        if (file) {
          if (file.type !== "application/pdf") {
            this.fileError = "Only PDF files are allowed.";
            this.uploadedFile = null;
            return;
          }
          if (file.size > 32 * 1024 * 1024) {
            this.fileError = "File exceeds the 32MB size limit.";
            this.uploadedFile = null;
            return;
          }
          this.uploadedFile = file;
        }
      },
      submitForm() {
  if (!this.isFormValid) {
    alert("Please complete all required fields and upload a valid file.");
    return;
  }

  this.loading = true;

  const readFileAsBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };

  Promise.all([
    readFileAsBase64(this.uploadedFile),
    this.isResubmission && this.revisedFile ? readFileAsBase64(this.revisedFile) : Promise.resolve(null)
  ])
    .then(([originalBase64, revisedBase64]) => {
      const payload = {
        name: this.formData.name,
        email: this.formData.email,
        memoType: this.formData.memoType,
        email1: this.formData.email1,
        dateType: this.formData.dateType,
        additionalMemoInfo: this.formData.additionalMemoInfo,
        otherExtraOption: this.otherExtraOption,
        departments: this.selectedMain,
        approvers: this.selectedSub,
        additionalOptions: this.selectedExtras,
        fileName: this.uploadedFile.name,
        fileData: originalBase64,
        isResubmission: this.isResubmission,
        revisedFileName: this.isResubmission ? this.revisedFile?.name : '',
        revisedFileData: revisedBase64
      };

      google.script.run
        .withSuccessHandler((refNumber) => {
          this.loading = false;
          alert(`Memo submitted successfully!\n\nPlease save this Memo Reference Number: ${refNumber}`);
          this.generatedRefNumber = refNumber;

          // Reset form
          this.formData.memoType = "";
          this.formData.email1 = "";
          this.formData.dateType = "";
          this.formData.additionalMemoInfo = "";
          this.otherExtraOption = "";
          this.selectedMain = [];
          this.selectedSub = [];
          this.selectedExtras = [];
          this.uploadedFile = null;
          this.revisedFile = null;
        })
        .withFailureHandler(error => {
          this.loading = false;
          alert("Submission failed: " + error.message);
        })
        .processFormData(payload);
    })
    .catch((error) => {
      this.loading = false;
      alert("Failed to read file(s): " + error.message);
    });
},


      getBase64FromFile(file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        return reader.result.split(',')[1]; // Return the base64-encoded string
      }
    }
  });
  </script>
</body>

</html>
